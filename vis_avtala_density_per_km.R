library(tidyr)
library(dplyr)
library(ggplot2)
library(readxl)
library(readr)
library(xlsx)
locale("he")
Sys.setlocale("LC_ALL", "Hebrew")

#import files
crime <- read.csv('C:\\Master\\Semester D\\??????????????????????\\files\\tikim.csv',encoding = "UTF-8")
avtala <- read.csv('C:\\Master\\Semester D\\??????????????????????\\files\\avtala_V2.csv',encoding = "UTF-8")
migzar <- read.csv('C:\\Master\\Semester D\\??????????????????????\\files\\migzar.csv',encoding = "UTF-8")
general <- read.csv('C:\\Master\\Semester D\\??????????????????????\\files\\general.csv',encoding = "UTF-8")
coords <- read.csv('C:\\Master\\Semester D\\??????????????????????\\files\\coords.csv',encoding = "UTF-8")

coords <- coords[,c(1:2,6)]

#change columns name for joins
names(crime)[names(crime) == "X.U.FEFF.Year"] <- "Year"
names(avtala)[names(avtala) == "X.U.FEFF.Quarter"] <- "Quarter"
names(avtala)[names(avtala) == "Name"] <- "Yeshuv"
names(migzar)[names(migzar) == "X.U.FEFF.city"] <- "Yeshuv"
names(general)[names(general) == "X.U.FEFF.Yeshuv"] <- "Yeshuv"
names(coords)[names(coords) == "X.U.FEFF.X"] <- "X"
names(coords)[names(coords) == "MGLSDE_LOC"] <- "Yeshuv"

#inner-joins
panel <- merge(crime, avtala,  by=c("Yeshuv","Quarter"))
panel <- merge(panel, migzar, by=c("Yeshuv","Year"))

#panel <- panel[,c(1:6,8:16,26:27,30)]


panel <- merge(panel, general, by=c("Yeshuv"))
panel <- merge(panel, coords, by=c("Yeshuv"))

#setting types
panel$Year <- as.factor(panel$Year)
panel$religious_in_city <- as.factor(panel$religious_in_city)
panel$Population.density.per.km <- as.numeric(panel$Population.density.per.km)
panel$total_population <- as.numeric(panel$total_population)
panel$population_man <- as.numeric(panel$population_man)
panel$population_woman <- as.numeric(panel$population_woman)
panel$avg_salary <- as.numeric(panel$avg_salary)
panel$avg_salary_man <- as.numeric(panel$avg_salary_man)
panel$avg_salary_woman <- as.numeric(panel$avg_salary_woman)
panel$self.employed <- as.numeric(panel$self.employed) 
panel$avg_salary_self_employed <- as.numeric(panel$avg_salary_self_employed)
panel$salaried.employee <- as.numeric(panel$salaried.employee)
panel$unemployed.rate <- as.numeric(sub("%","",panel$unemployed.rate))

head(panel)
str(panel)
#write.csv(panel, file = "panel_crimes_V2.csv")


#connection between crime and avtala
panel%>%
  filter(!(PoliceDistrict %in% c('???????? ????','???????? ??????????','???????? ????')))%>%
  filter(Year %in% c(2018,2019,2020))%>%
  filter(!(Group %in% c('?????????? ??????????')))%>%
  ggplot(aes(x=unemployed.rate, y=Tikim/population, color=PoliceDistrict)) +
  geom_point()+
  #geom_smooth(method=lm, se=FALSE, fullrange = FALSE)+
  facet_grid(PoliceDistrict~Year)+
  xlab('?????????? ??????????')+
  ylab('?????????? ???????????? ???????????? ????????????????????') +
  ggtitle("?????? ?????? ?????????? ???????????? ?????? ???????? ??????????????")+
  labs(color ="????????")+
  theme_bw()+
  scale_color_manual(values=c("#00008B", "#0000FF", "#4169E1","#FF0000","#DC143C"))+
  #scale_color_brewer(palette = "#9999CC")
  theme(plot.title = element_text(hjust = 0.5))


#connection between population and crime
panel%>%
  filter(!(PoliceDistrict %in% c('???????? ????','???????? ??????????','???????? ??????????')))%>%
  filter(Year %in% c(2018,2019,2020))%>%
  filter(!(Group %in% c('?????????? ??????????')))%>%
  ggplot(aes(x=Population.density.per.km , y = Tikim/population, color=PoliceDistrict)) +
  geom_point()+
  #geom_smooth(method=lm, se=FALSE, fullrange = FALSE)+
  facet_grid(PoliceDistrict~Year)+
  ylab('?????????? ???????????? ???????????? ????????????????????')+
  xlab('???????????? ?????????????????? ????"??') +
  ggtitle("?????? ?????? ?????????? ?????????????? ?????? ???????? ??????????????")+
  labs(color ="????????")+
  theme_bw()+
  #ylim(0,200)+
  scale_color_manual(values=c("#00008B", "#0000FF", "#4169E1","#FF0000","#DC143C"))+
  #scale_color_brewer(palette = "#9999CC")
  theme(plot.title = element_text(hjust = 0.5))

  


